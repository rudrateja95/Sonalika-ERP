<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>DASHMIN - Bootstrap Admin Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
<link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

<!-- Google Web Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Icon Font Stylesheet -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- Libraries Stylesheet -->
<link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css') }}" rel="stylesheet">

<!-- Customized Bootstrap Stylesheet -->
<link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

<!-- Template Stylesheet -->
<link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

</head>

<body>
    <div class="container-fluid position-relative bg-white d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->


        <!-- Sidebar Start -->
{% include 'menu.html' %}
        <!-- Sidebar End -->


        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
             {% include 'navbar.html' %}
            <!-- Navbar End -->


            <!-- Orde Form -->
 <div class="container-fluid pt-4 px-4">

  <!-- Order Form CARD -->
<div class="container-fluid py-4 px-3 px-md-4 bg-light">

  <!-- MAIN CARD -->
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">

    <!-- HEADER (color) -->
    <div class="bg-primary text-white p-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
        <div>
          <h3 class="mb-1 fw-bold">Create New Order</h3>
        </div>
        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">Order Form</span>
      </div>
    </div>

    <div class="card-body p-3 p-md-4">

      <!-- CLIENT + DATE -->
      <div class="row g-3 mb-4">

        <div class="col-md-6">
          <label class="form-label fw-semibold">Client</label>
          <select class="form-select form-select-lg shadow-sm" name="client_id" required>
          <option value="">Select Client</option>
          {% for c in clients %}
            <option value="{{ c.id }}" class="text-center">{{ c.full_name }}</option>
          {% endfor %}
          </select>

        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Date & Time</label>
           <input type="datetime-local"
       class="form-control form-control-lg shadow-sm text-center"
       id="order_datetime">
       </div>

      </div>

      <hr class="my-4">



      <!-- ORDER ITEMS -->
      <div id="ordersContainer">

        <div class="card border-0 shadow-sm rounded-4 mb-4">
          <div class="card-body p-3 p-md-4">

            <div class="d-flex align-items-center justify-content-between mb-3">
              <h6 class="mb-0 fw-bold">Order Item</h6>
              <span class="badge bg-secondary rounded-pill px-3 py-2">Item 1</span>
            </div>

            <div class="row g-3">

              <!-- LEFT -->
              <div class="col-md-12">

                <select class="form-select shadow-sm mb-3" id="styleSelect">
                  <option value="">Select Style</option>
                </select>

                <!-- Image Preview -->
                <div class="p-2 border rounded-3 bg-white text-center shadow-sm mb-3">
                  <img id="styleImage"
                       src=""
                       class="img-fluid rounded d-none"
                       style="max-height:220px;">
                  <div class="text-muted small" id="imgHint">Style preview</div>
                </div>

                             <div class="row g-3 align-items-end mt-4 mb-4">

  <div class="col-md-3">
    <label class="form-label fw-semibold">Gross Weight (gm)</label>
    <input type="text" class="form-control bg-light" id="gold_wt" readonly>
  </div>

  <div class="col-md-3">
    <label class="form-label fw-semibold">Total Diamonds</label>
    <input type="text" class="form-control bg-light" id="total_gem_count" readonly>
  </div>

  <div class="col-md-3">
    <label class="form-label fw-semibold">Total Diamond Weight (Ct)</label>
    <input type="text" class="form-control bg-light" id="total_gem_ct" readonly>
  </div>

<div class="col-md-3">
  <label class="form-label fw-semibold">Net Weight (gm)</label>
  <input type="text" class="form-control bg-light" id="total_weight" readonly>
</div>


</div>


              <!-- RIGHT -->
  <div class="table-responsive shadow-sm rounded-3 border bg-white mb-3">

  <table class="table table-sm table-striped table-hover mb-0 align-middle">
    <thead class="table-primary">
      <tr>
        <th>Size</th>
        <th>Pcs</th>
        <th>Shape</th>
        <th>Sieve Range</th>
        <th>Sieve Size</th>
        <th>Ct / Pc</th>
      </tr>
    </thead>
    <tbody id="roundTable">
      <tr><td colspan="7" class="text-center text-muted">Select a style</td></tr>
    </tbody>
  </table>
</div>


                <label class="form-label fw-semibold">Diamond Clarity</label>
<select class="form-select shadow-sm mb-3" id="diamond_clarity">
  <option value="">Diamond Clarity</option>
  <option value="VVS">VVS</option>
  <option value="VS">VS</option>
  <option value="SI">SI</option>
  <option value="IJ">IJ</option>
</select>



<label class="form-label fw-semibold">Gold Color</label>
<select class="form-select shadow-sm mb-3" id="gold_color">
  <option value="">Gold Color</option>
  <option value="YELLOW GOLD">YELLOW GOLD</option>
  <option value="ROSE GOLD">ROSE GOLD</option>
  <option value="WHITE GOLD">WHITE GOLD</option>
</select>

                



  <label class="form-label fw-semibold">Diamond Color</label>
<select class="form-select shadow-sm mb-3" id="diamond_color">
  <option value="">Diamond Color</option>
  <option value="EF">EF</option>
  <option value="FG">FG</option>
  <option value="GH">GH</option>
  <option value="HI">HI</option>
  <option value="IJ">IJ</option>
</select>



                

                <label class="form-label fw-semibold">Gold Purity</label>
<select class="form-select shadow-sm mb-3" id="goldPurity">
  <option value="">Gold Purity</option>
  <option value="0.38">9 KT</option>
  <option value="0.59">14 KT</option>
  <option value="0.76">18 KT</option>
  <option value="0.96">22 KT</option>
</select>

              </div>

 

            </div>

          </div>
        </div>

      </div>

      <!-- ADD ITEM -->
     <!-- <div class="d-grid d-md-flex justify-content-md-center gap-2 mb-4">
        <button type="button" class="btn btn-outline-primary btn-lg px-4" onclick="addOrder()">
          + Add New Order Item
        </button>
      </div>-->

      <hr class="my-4">

      <!-- ORDER SUMMARY -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h5 class="mb-0 fw-bold">Order Summary</h5>
          <small class="text-muted">Final amount and remarks</small>
        </div>
        <span class="badge bg-success rounded-pill px-3 py-2">Ready</span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
      <label class="form-label fw-semibold">Total Amount</label>
<input type="number" id="totalAmount" class="form-control form-control-lg shadow-sm" placeholder="0">
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Remark</label>
          <textarea class="form-control shadow-sm" rows="3" placeholder="Order note..."></textarea>
        </div>
                <div class="col-md-6">
          <label class="form-label fw-semibold">Delivery Date & Time</label>
          <input type="datetime-local"
       class="form-control form-control-lg shadow-sm"
       id="delivery_datetime">
        </div>

      </div>

      <!-- SUBMIT -->
      <div class="d-grid d-md-flex justify-content-md-center">
       <button id="createOrderBtn" class="btn btn-primary btn-lg px-5 shadow" type="button">
  Create Order
</button>

      </div>

    </div>
  </div>
</div>
<!-- Order Form End -->


            <!-- Footer Start -->
             {% include 'footer.html' %}
            <!-- Footer End -->
        </div>
        <!-- Content End -->


        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    </div>

    <!-- JavaScript Libraries -->


  <!-- create order JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  // ---------- Elements ----------
  const styleSelect      = document.getElementById("styleSelect");
  const styleImage       = document.getElementById("styleImage");
  const goldWtInput      = document.getElementById("gold_wt");
  const gemCountInput    = document.getElementById("total_gem_count");
  const gemCtInput       = document.getElementById("total_gem_ct");     // Diamond Weight (Ct)
  const totalWeightInput = document.getElementById("total_weight");     // Total Weight (gm)
  const roundTable       = document.getElementById("roundTable");

  if (!styleSelect) {
    console.error("styleSelect not found");
    return;
  }

  // ---------- Helpers ----------
  const toNum = (v, def = 0) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  };

  // Extract first number from "1.75 x 1.75"
  function sizeTextToMm(sizeText) {
    const m = String(sizeText || "").match(/(\d+(\.\d+)?)/);
    if (!m) return null;

    // ✅ Normalize to 1 decimal so 1.00 => 1.0 (important for lookup)
    return Number(parseFloat(m[1]).toFixed(1));
  }

  // NET Weight (gm) = Gold (gm) - Diamond (ct * 0.2)
  function updateTotalWeight() {
    const goldWt    = toNum(goldWtInput?.value, 0);   // gm
    const diamondCt = toNum(gemCtInput?.value, 0);    // ct

    const totalWt = goldWt - (diamondCt * 0.2);
    if (totalWeightInput) totalWeightInput.value = totalWt.toFixed(3);
  }

  function setTableMessage(msg) {
    if (!roundTable) return;
    roundTable.innerHTML = `<tr><td colspan="7" class="text-center">${msg}</td></tr>`;
  }

  function resetUI() {
    if (styleImage) {
      styleImage.classList.add("d-none");
      styleImage.src = "";
    }

    if (goldWtInput) goldWtInput.value = "";
    if (gemCountInput) gemCountInput.value = "";
    if (gemCtInput) gemCtInput.value = "";
    if (totalWeightInput) totalWeightInput.value = "";

    setTableMessage("Select a style");
  }

  // ---------- Load styles ----------
  async function loadStyles() {
    try {
      const res = await fetch("/api/styles");
      const styles = await res.json();

      styleSelect.innerHTML = `<option value="">Select Style</option>`;
      (styles || []).forEach(s => {
        styleSelect.insertAdjacentHTML("beforeend", `<option value="${s}">${s}</option>`);
      });
    } catch (e) {
      console.error("Failed to load styles:", e);
      styleSelect.innerHTML = `<option value="">Failed to load styles</option>`;
    }
  }

  // ---------- Lookup sieve for rendered round table ----------
  async function fillSieveForRoundTable() {
    if (!roundTable) return;

    const rows = Array.from(roundTable.querySelectorAll("tr[data-mm]"));

    if (!rows.length) {
      if (gemCtInput) gemCtInput.value = "0.000";
      updateTotalWeight();
      return;
    }

    // ✅ Build unique mm list (strings ok)
    const mmList = [...new Set(rows.map(r => String(r.dataset.mm)))];

    let map = {};
    try {
      const res = await fetch("/api/sieve-lookup-batch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mm_list: mmList })
      });
      map = await res.json();
    } catch (e) {
      console.error("Sieve lookup failed:", e);
      map = {};
    }

    let totalDiamondCt = 0;

    rows.forEach(row => {
      const mm = String(row.dataset.mm);
      const info = map[mm] || null;

      const sieveRangeCell = row.querySelector(".sieve-range");
      const sieveSizeCell  = row.querySelector(".sieve-size");
      const ctPerPcCell    = row.querySelector(".ct-per-pc");

      if (sieveRangeCell) sieveRangeCell.textContent = info?.sieve_range ?? "-";
      if (sieveSizeCell)  sieveSizeCell.textContent  = info?.sieve_size  ?? "-";
      if (ctPerPcCell)    ctPerPcCell.textContent    = (info?.ct_weight_per_piece ?? "-");

      // ✅ Total Ct = pcs * ct_per_piece
      const pcs = toNum(row.children?.[1]?.textContent, 0); // 2nd column = Pcs
      const ctPerPc = toNum(info?.ct_weight_per_piece, 0);
      totalDiamondCt += (pcs * ctPerPc);
    });

    if (gemCtInput) gemCtInput.value = totalDiamondCt.toFixed(3);
    updateTotalWeight();
  }

  // ---------- On style change ----------
  styleSelect.addEventListener("change", async function () {
    const styleNo = this.value;

    resetUI();
    setTableMessage("Loading...");

    if (!styleNo) {
      setTableMessage("Select a style");
      return;
    }

    try {
      const res = await fetch(`/api/style/${encodeURIComponent(styleNo)}`);
      const data = await res.json();

      if (!res.ok || !data?.ok) {
        alert(data?.message || "Style not found");
        setTableMessage("No gem details");
        return;
      }

      // Image
      if (styleImage && data.image_url) {
        styleImage.src = data.image_url;
        styleImage.classList.remove("d-none");
      }

      // Gold wt
      if (goldWtInput) goldWtInput.value = data.gold_wt ?? "";
      updateTotalWeight();

      // Round details
      let rounds = data.round_details;

      if (typeof rounds === "string") {
        try { rounds = JSON.parse(rounds); } catch { rounds = []; }
      }
      if (!Array.isArray(rounds)) rounds = [];

      if (!rounds.length) {
        setTableMessage("No gem details");
        if (gemCountInput) gemCountInput.value = 0;
        if (gemCtInput) gemCtInput.value = "0.000";
        updateTotalWeight();
        return;
      }

      // Render rows + total pcs
      let totalPcs = 0;

      roundTable.innerHTML = rounds.map(r => {
        const pcs = toNum(r.pcs, 0);
        totalPcs += pcs;

        const mm = sizeTextToMm(r.size); // ✅ normalized
        const mmAttr = (mm !== null) ? `data-mm="${mm}"` : "";

        return `
          <tr ${mmAttr}>
            <td>${r.size ?? ""}</td>
            <td>${pcs}</td>
            <td>${r.shape ?? ""}</td>
            <td class="sieve-range text-muted">...</td>
            <td class="sieve-size text-muted">...</td>
            <td class="ct-per-pc text-muted">...</td>
          </tr>
        `;
      }).join("");

      if (gemCountInput) gemCountInput.value = totalPcs;

      // Fill sieve + calculate Diamond Weight + Total Weight
      await fillSieveForRoundTable();

    } catch (err) {
      console.error("Fetch failed:", err);
      alert("Network / server error. Check console + Flask terminal.");
      setTableMessage("Error");
      if (gemCountInput) gemCountInput.value = "";
      if (gemCtInput) gemCtInput.value = "";
      if (totalWeightInput) totalWeightInput.value = "";
    }
  });

  // ---------- Init ----------
  resetUI();
  loadStyles();

});
</script>

<!-- DATE Auto Fill -->


<script>
document.addEventListener("DOMContentLoaded", () => {
  const orderDT = document.getElementById("order_datetime");
  const deliveryDT = document.getElementById("delivery_datetime");

  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 16);

  if (orderDT) orderDT.value = local;

  // optional: delivery default = same as order time
  if (deliveryDT && !deliveryDT.value) deliveryDT.value = local;
});
</script>

<!-- Form fill after send db -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("createOrderBtn");

  if (!btn) {
    console.log("❌ createOrderBtn not found on this page");
    return;
  }

  console.log("✅ createOrderBtn found. Click is enabled.");

  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log("✅ Create Order clicked");

    const payload = {
      client_id: document.querySelector('select[name="client_id"]')?.value || "",
      order_datetime: document.getElementById("order_datetime")?.value || "",
      delivery_datetime: document.getElementById("delivery_datetime")?.value || null,
      style_no: document.getElementById("styleSelect")?.value || "",

      diamond_clarity: document.getElementById("diamond_clarity")?.value || null,
      gold_color: document.getElementById("gold_color")?.value || null,
      diamond_color: document.getElementById("diamond_color")?.value || null,

      gold_purity: document.getElementById("goldPurity")?.options?.[document.getElementById("goldPurity").selectedIndex]?.text || null,
      gold_purity_factor: document.getElementById("goldPurity")?.value || null,

      total_amount: document.getElementById("totalAmount")?.value || 0,
      remark: document.querySelector("textarea")?.value || ""
    };

    if (!payload.client_id) return alert("Select Client");
    if (!payload.order_datetime) return alert("Select Order Date & Time");
    if (!payload.style_no) return alert("Select Style");

    try {
      const res = await fetch("/api/create-order", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      console.log("Status:", res.status, "Response:", text);

      let data = {};
      try { data = JSON.parse(text); } catch {}

      if (!res.ok) {
        alert(`❌ API Error (${res.status})\n${data.error || text}`);
        return;
      }

      alert("✅ Order Saved! ID: " + (data.order_id || ""));
    } catch (err) {
      console.error("FETCH FAILED:", err);
      alert("❌ Fetch failed. Check console.");
    }
  });
});
</script>















<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>

<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}"></script>

<!-- Template Javascript -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>

</html>