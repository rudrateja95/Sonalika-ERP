<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Production Board - ERP</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css') }}" rel="stylesheet">

  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
  <div class="container-fluid position-relative bg-white d-flex p-0">

    {% include 'production_menu.html' %}

    <div class="content">
      {% include 'navbar.html' %}

      <div class="container-fluid pt-4 px-4">
        <div class="bg-light rounded p-4">

          <div class="d-flex align-items-center justify-content-between mb-4">
            <h4 class="mb-0">Production Orders</h4>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-primary text-center">
                <tr>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Style</th>
                  <th>Order Date</th>
                  <th>Delivery Date</th>
                  <th>Diamond</th>
                  <th>Gold</th>
                  <th>Amount</th>
                  <th>Remark</th>
                  <th>Details</th>
                  <th>Report</th>
                </tr>
              </thead>

              <tbody>
                {% for o in orders %}
                <tr>
                  <td class="text-center">{{ o.id }}</td>
                  <td class="fw-semibold">{{ o.client.full_name }}</td>

                  <td class="fw-bold">{{ o.style_no }}</td>

                  <td>{{ o.order_datetime.strftime("%d-%b-%Y %I:%M %p") }}</td>

                  <td>
                    {{ o.delivery_datetime.strftime("%d-%b-%Y %I:%M %p") if o.delivery_datetime else "-" }}
                  </td>


                  <td>{{ o.diamond_clarity or "-" }} / {{ o.diamond_color or "-" }}</td>

                  <td>
                    {{ o.gold_color or "-" }}<br>
                    <small class="text-muted">{{ o.gold_purity or "-" }}</small>
                  </td>

                  <td class="fw-bold text-success">
                    ₹ {{ "{:,.0f}".format(o.total_amount or 0) }}
                  </td>

                  <td>{{ o.remark or "-" }}</td>

<td class="text-center">
         <button class="btn btn-sm btn-primary" type="button"
                      onclick="openStyleDetails('{{ o.style_no }}')">
                      View
                    </button>


</td>
<td class="text-center">
<button class="btn btn-sm btn-primary"
onclick="openProductionUpdateModal('{{ o.id }}','{{ o.style_no }}','{{ o.gold_color }}','{{ o.gold_purity }}')">
  Update
</button>
</td>

                </tr>
                {% else %}
                <tr>
                  <td colspan="10" class="text-center text-muted">
                    No production orders found
                  </td>
                </tr>
                {% endfor %}
              </tbody>

            </table>
          </div>

        </div>
      </div>

      <!-- ✅ Modal -->
      <div class="modal fade" id="styleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">

            <div class="modal-header">
              <h5 class="modal-title">Style No: <span id="modalStyleNo"></span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="row g-3">

                <!-- LEFT: IMAGE -->
                <div class="col-md-4 text-center">
                  <img id="modalStyleImage" class="img-fluid rounded border d-none" style="max-height:280px;">
                  <div id="modalImgHint" class="text-muted small">Loading image...</div>
                </div>

                <!-- RIGHT: SUMMARY + TABLE -->
                <div class="col-md-8">

                  <!-- Summary -->
                  <div class="row g-2">
                    <div class="col-md-3">
                      <div class="bg-light border rounded p-2 text-center">
                        <div class="small text-muted">Gross Weight (gm)</div>
                        <div class="fw-bold" id="modalGrossWt">-</div>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="bg-light border rounded p-2 text-center">
                        <div class="small text-muted">Total Diamonds</div>
                        <div class="fw-bold" id="modalTotalPcs">-</div>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="bg-light border rounded p-2 text-center">
                        <div class="small text-muted">Total Diamond Weight (Ct)</div>
                        <div class="fw-bold" id="modalTotalCt">-</div>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="bg-light border rounded p-2 text-center">
                        <div class="small text-muted">Net Weight (gm)</div>
                        <div class="fw-bold" id="modalNetWt">-</div>
                      </div>
                    </div>
                  </div>

                  <!-- Round Details -->
                  <div class="mt-3">
                    <h6 class="mb-2">Round Details</h6>

                    <div class="table-responsive border rounded">
                      <table class="table table-sm table-striped mb-0">
                        <thead class="table-primary">
                          <tr>
                            <th>Size</th>
                            <th>Pcs</th>
                            <th>Shape</th>
                            <th>Sieve Range</th>
                            <th>Sieve Size</th>
                            <th>Ct / Pc</th>
                          </tr>
                        </thead>

                        <tbody id="modalRoundTable">
                          <tr>
                            <td colspan="6" class="text-center text-muted">Loading...</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ================= Production Update Modal ================= -->
<div class="modal fade" id="productionUpdateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0">Production Update</h5>
          <small class="text-muted">
            Order ID: <span id="pu_order_id">-</span> |
            Style: <span id="pu_style_no">-</span>
          </small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="puTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCasting" type="button">
              Casting
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFiling" type="button">
              Pre-Filing
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPre-Ep" type="button">
              Pre-EP
            </button>
          </li>
                    <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPostFiling" type="button">
              Post-Filing
            </button>
          </li>
                    <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPost-Ep" type="button">
              Post-EP
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPp" type="button">
              PP
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSetting" type="button">
              Setting
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAssembly" type="button">
              Assembly
            </button>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFP" type="button">
              FP
            </button>
          </li>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabQC" type="button">
              QC
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHM" type="button">
              HM
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabIGI" type="button">
              IGI
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDWT" type="button">
              DWT
            </button>
          </li>
                    <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRepair" type="button">
              Repair
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFinalQC" type="button">
              FinalQC
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabTagPrint" type="button">
              Tag Print
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3">

<!-- ============ CASTING ============ -->
<div class="tab-pane fade show active" id="tabCasting">
  <div class="row g-3">

    <!-- Date -->
    <div class="col-md-3">
      <label class="form-label">Date</label>
      <input type="date" class="form-control" id="casting_date">
    </div>

    <!-- Employee Name -->
<div class="col-md-3">
  <label class="form-label">Employee Name</label>
  <select class="form-select" id="casting_employee_name">
    <option value="">Loading...</option>
  </select>
</div>



    <!-- Employee ID -->
    <div class="col-md-3">
      <label class="form-label">Employee ID</label>
      <input type="text" class="form-control" id="casting_employee_id" placeholder="Enter Employee ID">
    </div>

    <!-- Purity -->
    <div class="col-md-3">
      <label class="form-label">Purity</label>
      <input type="text" class="form-control" id="casting_purity" placeholder="auto_fill e.g. 9kt">
    </div>

    <!-- Colour -->
    <div class="col-md-3">
      <label class="form-label">Colour</label>
      <input type="text" class="form-control" id="casting_colour" placeholder="Yellow/White/Rose">
    </div>

    <!-- Wax -->
    <div class="col-md-3">
      <label class="form-label">Wax</label>
      <input type="text" class="form-control" id="casting_wax">
    </div>

    <!-- Karat -->
<div class="col-md-3">
  <label class="form-label">Gold Karat</label>
  <select class="form-select" id="casting_karat">
    <option value="">Select Karat</option>
    <option value="9">9 KT</option>
    <option value="14">14 KT</option>
    <option value="18">18 KT</option>
    <option value="22">22 KT</option>
     <option value="24">24 KT</option>
  </select>
</div>

    <!-- Gold/gm -->
    <div class="col-md-3">
      <label class="form-label">Gold/gm</label>
      <input type="number" step="0.001" class="form-control" id="casting_pure_gold">
    </div>

    <!-- Alloy -->
    <div class="col-md-3">
      <label class="form-label">Alloy</label>
      <input type="number" step="0.001" class="form-control" id="casting_alloy">
    </div>

    <!-- Net -->
    <div class="col-md-3">
      <label class="form-label">Net</label>
      <input type="number" step="0.001" class="form-control" id="casting_net">
    </div>

    <!-- Wastage -->
    <div class="col-md-3">
      <label class="form-label">Wastage</label>
      <input type="number" step="0.001" class="form-control" id="casting_wastage">
    </div>

    <!-- Receive Finish -->
    <div class="col-md-3">
      <label class="form-label">Receive Finish</label>
      <input type="number" step="0.001" class="form-control" id="casting_finish">
    </div>

    <!-- Receive Extra -->
    <div class="col-md-3">
      <label class="form-label">Receive Extra</label>
      <input type="number" step="0.001" class="form-control" id="casting_extra">
    </div>

    <div class="col-md-3">
      <label class="form-label">Receive PC</label>
      <input type="number" class="form-control" id="casting_receive_pc">
    </div>

    <!-- Casting Remark -->
<div class="col-md-6">
  <label class="form-label">Remark</label>
  <textarea class="form-control" id="casting_remark" rows="2"
    placeholder="Enter casting remark..."></textarea>
</div>

  </div>
</div>


          <!-- ============ Filing ============ -->
          <div class="tab-pane fade" id="tabFiling">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="filing_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="filing_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="filing_dust_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="filing_remark">
              </div>

            </div>
          </div>
          <!-- ============ Filing ============ -->
          <div class="tab-pane fade" id="tabFiling">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="filing_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="filing_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="filing_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="filing_remark">
              </div>

            </div>
          </div>

          <!-- ============ EP ============ -->
          <div class="tab-pane fade" id="tabPre-Ep">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="fp_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="fp_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="fp_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>
                    <!-- ============ Filing ============ -->
          <div class="tab-pane fade" id="tabPostFiling">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="filing_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="filing_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="filing_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="filing_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="filing_remark">
              </div>

            </div>
          </div>
                    <!-- ============ EP ============ -->
          <div class="tab-pane fade" id="tabPost-Ep">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="fp_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="fp_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="fp_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>
          <!-- ============ PP ============ -->
          <div class="tab-pane fade" id="tabPp">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="fp_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="fp_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="fp_dust_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>

          <!-- ============ SETTING ============ -->
          <div class="tab-pane fade" id="tabSetting">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Dia PC</label>
                <input type="number" class="form-control" id="st_dia_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dia CT</label>
                <input type="number" step="0.001" class="form-control" id="st_dia_ct">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dia GM</label>
                <input type="number" step="0.001" class="form-control" id="st_dia_gm">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Wt</label>
                <input type="number" step="0.001" class="form-control" id="st_dust_wt">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="st_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="st_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="st_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="st_receive_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>
          <!-- ============ ASSEMBLY ============ -->
          <div class="tab-pane fade" id="tabAssembly">
    <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="fp_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="fp_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="fp_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>
          <!-- ============ FP ============ -->
          <div class="tab-pane fade" id="tabFP">
    <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="fp_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="fp_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust Weight</label>
                <input type="number" step="0.001" class="form-control" id="fp_dust_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Dust PC</label>
                <input type="number" class="form-control" id="fp_dust_pc">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>

          <!-- ============ QC ============ -->
          <div class="tab-pane fade" id="tabQC">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>


                            <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>






              
              <div class="col-md-6">
                <label class="form-label">Remark</label>
                <input type="text" class="form-control" id="fp_remark">
              </div>

            </div>
          </div>
          <!-- ============ HM ============ -->
          <div class="tab-pane fade" id="tabHM">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="qc_wastage">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Diamond wt</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Diamond PCs</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

           


              
              

            </div>
          </div>
          <!-- ============ IGI ============ -->
          <div class="tab-pane fade" id="tabIGI">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Diamond wt</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Diamond PCs</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>



  

 



              
              <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              

            </div>
          </div>
          <!-- ============ DWT ============ -->
          <div class="tab-pane fade" id="tabDWT">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>




 
              
               <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

                            <div class="col-md-3">
                <label class="form-label">Diamond wt</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Diamond PCs</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

            </div>
          </div>
          <!-- ============ Final QC ============ -->
          <div class="tab-pane fade" id="tabFinalQC">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="qc_wastage">
              </div>

              <div class="col-md-3">
                <label class="form-label">IGI Cert</label>
                <select class="form-select" id="qc_igi_cert">
                  <option value="">-</option>
                  <option value="YES">YES</option>
                  <option value="NO">NO</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">HUID Stamp</label>
                <select class="form-select" id="qc_huid_stamp">
                  <option value="">-</option>
                  <option value="DONE">DONE</option>
                  <option value="PENDING">PENDING</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Final QC</label>
                <select class="form-select" id="qc_final_status">
                  <option value="">-</option>
                  <option value="PASS">PASS</option>
                  <option value="HOLD">HOLD</option>
                  <option value="REWORK">REWORK</option>
                </select>
              </div>

            </div>
          </div>
          <!-- ============ Repair ============ -->
          <div class="tab-pane fade" id="tabRepair">
            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label">Issue Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_issue_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Issue PC</label>
                <input type="number" class="form-control" id="qc_issue_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive Weight</label>
                <input type="number" step="0.001" class="form-control" id="qc_receive_weight">
              </div>

              <div class="col-md-3">
                <label class="form-label">Receive PC</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Wastage</label>
                <input type="number" step="0.001" class="form-control" id="qc_wastage">
              </div>


              <div class="col-md-3">
                <label class="form-label">Diamond wt</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>

              <div class="col-md-3">
                <label class="form-label">Diamond PCs</label>
                <input type="number" class="form-control" id="qc_receive_pc">
              </div>
                            
               <div class="col-md-3">
                <label class="form-label">Extra Metal Recieved</label>
                <input type="number" step="0.001" class="form-control" id="filing_receive_weight">
              </div>

            </div>
          </div>

          <!-- ============ TAG PRINT ============ -->
<div class="tab-pane fade" id="tabTagPrint">

  <div class="row g-3">

    <!-- Left: Tag Preview -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <div>
            <strong>Tag Preview</strong><br>
            <small class="text-muted">Ready to print</small>
          </div>
          <button type="button" class="btn btn-sm btn-primary" onclick="printTag()">
            <i class="bi bi-printer"></i> Print
          </button>
        </div>

        <div class="card-body">
          <!-- Tag Box -->
          <div id="tagPrintArea" class="border rounded p-3" style="width: 320px;">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-bold" id="tag_style_no">STYLE: -</div>
                <div class="small text-muted" id="tag_order_id">ORDER: -</div>
              </div>
              <div class="text-end">
                <div class="badge bg-dark" id="tag_purity">-</div>
                <div class="small" id="tag_colour">-</div>
              </div>
            </div>

            <hr class="my-2">

            <div class="d-flex justify-content-between small">
              <div>Issue Kt: <span id="tag_issue_kt">-</span></div>
              <div>Net: <span id="tag_net">-</span> gm</div>
            </div>

            <div class="mt-3 text-center">
              <!-- Barcode SVG -->
              <svg id="tagBarcode"></svg>
              <div class="small text-muted mt-1" id="tag_barcode_text">-</div>
            </div>
          </div>

          <small class="text-muted d-block mt-2">
            Tip: Barcode value uses Order ID + Style No.
          </small>
        </div>
      </div>
    </div>

    <!-- Right: Inputs -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <strong>Tag Details</strong>
        </div>

        <div class="card-body">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">Barcode Value</label>
              <input type="text" class="form-control" id="tag_barcode_value"
                     placeholder="Auto" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Net (gm)</label>
              <input type="text" class="form-control" id="tag_net_input"
                     placeholder="Auto" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Purity</label>
              <input type="text" class="form-control" id="tag_purity_input"
                     placeholder="Auto" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Colour</label>
              <input type="text" class="form-control" id="tag_colour_input"
                     placeholder="Auto" readonly>
            </div>

            <div class="col-md-12">
              <label class="form-label">Notes (optional)</label>
              <textarea class="form-control" id="tag_notes" rows="2"
                        placeholder="Any note to show on tag (optional)"></textarea>
            </div>

            <div class="col-md-12">
              <button type="button" class="btn btn-outline-primary w-100" onclick="generateTagBarcode()">
                <i class="bi bi-upc-scan"></i> Refresh Barcode
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>


        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-success" type="button" onclick="saveProductionUpdate()">Save</button>
      </div>

    </div>
  </div>
</div>


      {% include 'footer.html' %}
    </div>
  </div>

  <!-- JS Libraries -->








  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}"></script>
  <script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
  <script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
  <script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>

  <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}"></script>
  <script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}"></script>

  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- ✅ Production Board getting round details JS -->
  <script>
    function toNum(v, def = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : def;
    }

    // "1.20 x 1.20" -> 1.2 (1 decimal)
    function sizeTextToMm(sizeText) {
      const m = String(sizeText || "").match(/(\d+(\.\d+)?)/);
      if (!m) return null;
      return Number(parseFloat(m[1]).toFixed(1));
    }

    async function openStyleDetails(styleNo) {
      document.getElementById("modalStyleNo").textContent = styleNo;

      const img = document.getElementById("modalStyleImage");
      const hint = document.getElementById("modalImgHint");
      const tbody = document.getElementById("modalRoundTable");

      const grossWtEl = document.getElementById("modalGrossWt");
      const totalPcsEl = document.getElementById("modalTotalPcs");
      const totalCtEl = document.getElementById("modalTotalCt");
      const netWtEl = document.getElementById("modalNetWt");

      // reset UI
      img.classList.add("d-none");
      img.src = "";
      hint.textContent = "Loading image...";
      hint.classList.remove("d-none");

      grossWtEl.textContent = "-";
      totalPcsEl.textContent = "-";
      totalCtEl.textContent = "-";
      netWtEl.textContent = "-";

      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>`;

      // show modal
      const modal = new bootstrap.Modal(document.getElementById("styleModal"));
      modal.show();

      try {
        // 1) Style API
        const res = await fetch(`/api/style/${encodeURIComponent(styleNo)}`);
        const data = await res.json();

        if (!res.ok || !data?.ok) {
          hint.textContent = data?.message || "Style not found";
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">No data</td></tr>`;
          return;
        }

        // image
        if (data.image_url) {
          img.src = data.image_url;
          img.classList.remove("d-none");
          hint.classList.add("d-none");
        } else {
          hint.textContent = "No image";
        }

        // gross weight
        const grossWt = toNum(data.gold_wt, 0);
        grossWtEl.textContent = grossWt ? grossWt.toFixed(3) : "-";

        // round details
        let rounds = data.round_details;
        if (typeof rounds === "string") {
          try { rounds = JSON.parse(rounds); } catch { rounds = []; }
        }
        if (!Array.isArray(rounds)) rounds = [];

        if (!rounds.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No round details</td></tr>`;
          return;
        }

        // 2) Render rows + collect mm list + total pcs
        const mmList = [];
        let totalPcs = 0;

        tbody.innerHTML = rounds.map(r => {
          const size = (r.size ?? "").toString();
          const pcs = toNum(r.pcs, 0);
          const shape = (r.shape ?? "").toString();

          totalPcs += pcs;

          const mm = sizeTextToMm(size);
          if (mm !== null) mmList.push(String(mm));

          const rowClass = pcs === 0 ? "text-muted" : "";

          return `
            <tr class="${rowClass}" data-mm="${mm !== null ? mm : ""}">
              <td>${size}</td>
              <td>${pcs}</td>
              <td>${shape}</td>
              <td class="sieve-range">...</td>
              <td class="sieve-size">...</td>
              <td class="ct-per-pc">...</td>
            </tr>
          `;
        }).join("");

        totalPcsEl.textContent = totalPcs;

        // 3) Sieve lookup (batch)
        const uniqueMm = [...new Set(mmList.filter(Boolean))];

        let sieveMap = {};
        if (uniqueMm.length) {
          try {
            const sres = await fetch("/api/sieve-lookup-batch", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mm_list: uniqueMm })
            });
            sieveMap = await sres.json();
          } catch (e) {
            console.error("sieve lookup error:", e);
            sieveMap = {};
          }
        }

        // 4) Fill sieve columns
        tbody.querySelectorAll("tr[data-mm]").forEach(tr => {
          const mm = (tr.getAttribute("data-mm") || "").toString();
          const info = sieveMap[mm] || null;

          tr.querySelector(".sieve-range").textContent = info?.sieve_range ?? "-";
          tr.querySelector(".sieve-size").textContent = info?.sieve_size ?? "-";
          tr.querySelector(".ct-per-pc").textContent = info?.ct_weight_per_piece ?? "-";
        });

        // 5) Total Ct = sum(pcs * ct_per_piece)
        let totalCt = 0;
        tbody.querySelectorAll("tr").forEach(tr => {
          const pcs = toNum(tr.children?.[1]?.textContent, 0);
          const ctPerPc = toNum(tr.querySelector(".ct-per-pc")?.textContent, 0);
          totalCt += (pcs * ctPerPc);
        });

        totalCtEl.textContent = totalCt.toFixed(3);

        // 6) Net Weight (gm) = Gold(gm) - (Ct * 0.2)
        const netWt = grossWt - (totalCt * 0.2);
        netWtEl.textContent = netWt.toFixed(3);

      } catch (e) {
        console.error(e);
        hint.textContent = "Server / network error";
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error</td></tr>`;
      }
    }
  </script>







<script>
/* =========================================================
   PRODUCTION UPDATE MODAL - TOTAL SCRIPT (ISSUE KT -> TARGET KT)
   Your requirement (final):
   - casting_purity = TARGET KT (style purity auto-filled: 9kt/14kt/18kt/22kt/24kt) (readonly recommended)
   - casting_karat  = ISSUE KT (user selects: 9/14/18/22/24)
   - casting_pure_gold = ISSUE GOLD gm (user enters)
   - Auto-calc to CONVERT issue KT gold into target KT:
        pure_gold_content = issue_gm * fineness(issueKT)
        net_required      = pure_gold_content / fineness(targetKT)
        alloy_to_add      = net_required - pure_gold_content
   - Show:
        casting_alloy = alloy_to_add
        casting_net   = net_required
   - Works for: 9,14,18,22,24
========================================================= */

var puModal = null;

// KT → fineness
const KT_FINENESS = {
  9:  0.375,
  14: 0.585,
  18: 0.750,
  22: 0.916,
  24: 1.000
};

document.addEventListener("DOMContentLoaded", function () {
  const modalEl = document.getElementById("productionUpdateModal");
  if (modalEl) puModal = new bootstrap.Modal(modalEl);

  setupIssueToTargetCalc();
});

/* ---------------------------
   Helpers
--------------------------- */
function parseKt(val) {
  // supports: "22kt", "22 KT", "22K", "14kt", "24", etc.
  const t = String(val || "").toUpperCase().replace(/\s+/g, "");
  const m = t.match(/(\d+)/);
  if (!m) return null;
  const k = parseInt(m[1], 10);
  return (k === 9 || k === 14 || k === 18 || k === 22 || k === 24) ? k : null;
}

function toNum(val) {
  const n = parseFloat(val);
  return Number.isFinite(n) ? n : null;
}

function set3(el, n) {
  el.value = Number.isFinite(n) ? n.toFixed(3) : "";
}

/* ---------------------------
   MAIN CALC: Issue KT -> Target KT
--------------------------- */
function setupIssueToTargetCalc() {
  const targetPurityEl = document.getElementById("casting_purity");     // TARGET KT (style)
  const issueKaratEl   = document.getElementById("casting_karat");      // ISSUE KT (selected)
  const issueGmEl      = document.getElementById("casting_pure_gold");  // ISSUE GOLD gm
  const alloyEl        = document.getElementById("casting_alloy");      // Alloy to add
  const netEl          = document.getElementById("casting_net");        // Final net

  if (!targetPurityEl || !issueKaratEl || !issueGmEl || !alloyEl || !netEl) return;

  function calc() {
    const targetKt = parseKt(targetPurityEl.value);   // style purity
    const issueKt  = parseKt(issueKaratEl.value);     // issuing kt
    const issueGm  = toNum(issueGmEl.value);

    // Debug (optional)
    // console.log({ targetKt, issueKt, issueGm });

    if (!targetKt || !issueKt || issueGm === null) {
      alloyEl.value = "";
      netEl.value = "";
      return;
    }

    const fIssue  = KT_FINENESS[issueKt];
    const fTarget = KT_FINENESS[targetKt];

    if (!fIssue || !fTarget || fTarget === 0) {
      alloyEl.value = "";
      netEl.value = "";
      return;
    }

    // Pure gold content in issued metal
    const pureGoldContent = issueGm * fIssue;

    // Final net weight needed for target KT
    const netRequired = pureGoldContent / fTarget;

    // Alloy to add
    const alloyToAdd = netRequired - pureGoldContent;

    set3(alloyEl, alloyToAdd);
    set3(netEl, netRequired);
  }

  issueKaratEl.addEventListener("change", calc);
  issueGmEl.addEventListener("input", calc);

  // If target purity changes by autofill, still recalc
  targetPurityEl.addEventListener("input", calc);
}

/* ---------------------------
   OPEN MODAL
   orderId, styleNo, goldColor, goldPurity (style purity) from table
--------------------------- */
function openProductionUpdateModal(orderId, styleNo, goldColor, goldPurity) {
  document.getElementById("pu_order_id").innerText = orderId || "-";
  document.getElementById("pu_style_no").innerText = styleNo || "-";

  clearProductionModal();

  // Date = today (optional)
  const dateEl = document.getElementById("casting_date");
  if (dateEl) dateEl.value = new Date().toISOString().split("T")[0];

  // Colour autofill
  const colourEl = document.getElementById("casting_colour");
  if (colourEl) colourEl.value = goldColor || "";

  // TARGET purity autofill (style purity)
  const targetEl = document.getElementById("casting_purity");
  if (targetEl) targetEl.value = goldPurity || "";

  // Default ISSUE KT = 24 (common use-case) OR match style purity if you want:
  // Option A: default issue to 24
  const issueKaratEl = document.getElementById("casting_karat");
  if (issueKaratEl) issueKaratEl.value = "24";

  // Trigger calc if issue gm already present
  const issueGmEl = document.getElementById("casting_pure_gold");
  if (issueGmEl) issueGmEl.dispatchEvent(new Event("input"));

  puModal.show();
}

/* ---------------------------
   CLEAR MODAL
--------------------------- */
function clearProductionModal() {
  const ids = [
    // casting
    "casting_date","casting_karat","casting_purity","casting_colour","casting_wax",
    "casting_pure_gold","casting_alloy","casting_net","casting_wastage","casting_finish","casting_extra",
    // filing
    "filing_issue_weight","filing_issue_pc","filing_receive_weight","filing_receive_pc","filing_dust_weight","filing_dust_pc","filing_remark",
    // fp
    "fp_issue_weight","fp_issue_pc","fp_receive_weight","fp_receive_pc","fp_dust_weight","fp_dust_pc","fp_remark",
    // setting
    "st_dia_pc","st_dia_ct","st_dia_gm","st_dust_wt","st_issue_weight","st_issue_pc","st_receive_weight","st_receive_pc",
    // qc
    "qc_issue_weight","qc_issue_pc","qc_receive_weight","qc_receive_pc","qc_wastage","qc_igi_cert","qc_huid_stamp","qc_final_status"
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
}

/* ---------------------------
   SAVE (your original payload pattern)
--------------------------- */
function saveProductionUpdate() {
  const orderId = document.getElementById("pu_order_id").innerText;

  const payload = {
    order_id: orderId,

    casting: {
      date: document.getElementById("casting_date")?.value || "",
      target_purity: document.getElementById("casting_purity")?.value || "", // style KT
      issue_karat: document.getElementById("casting_karat")?.value || "",    // issued KT
      colour: document.getElementById("casting_colour")?.value || "",
      wax: document.getElementById("casting_wax")?.value || "",
      issue_gold_gm: document.getElementById("casting_pure_gold")?.value || "",
      alloy_to_add: document.getElementById("casting_alloy")?.value || "",
      net_required: document.getElementById("casting_net")?.value || "",
      wastage: document.getElementById("casting_wastage")?.value || "",
      finish: document.getElementById("casting_finish")?.value || "",
      extra: document.getElementById("casting_extra")?.value || ""
    }

    // If you still need other sections (filing/fp/setting/qc) add them here,
    // or merge with your old payload structure.
  };

  fetch("/api/production/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      alert("Saved Successfully ✅");
      puModal.hide();
    } else {
      alert(res.error || "Save failed ❌");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error ❌");
  });
}
</script>





</body>
</html>
